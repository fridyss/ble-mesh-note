## 3.4 网络层
网络层定义 "NetWork PDU"格式，该格式允许承载层传输"Lower Transport PDUs"，它对输入接口上接收到的传入消息进行解密和认证，并将其转发到上层和/或输出接口，对发送到输出网络接口的传出消息进行加密和认证，并将其转发到输出网络接口。
### 3.4.1 字节顺序
该层中的所有多字节数值应以“大端”形式发送，如第3.1.1.1节所述。
#### 3.4.2 地址 
网络层定义了四种基本类型的地址：未分配地址, 单播地址, 虚拟地址, 组地址。地址的长度为16位，其编码如表3.3所示。

| 值 | 地址类型 |
| --- | --- |
| 0b00000000-00000000 | 未分配地址 |
| 0b0xxxxxxx-xxxxxxxx | 单播地址 （除未分配地址）|
| 0b10xxxxxx-xxxxxxxx | 虚拟地址  |
| 0b11xxxxxx-xxxxxxxx | 组地址 |

*表3.3 16位地址分配 *

#### 3.4.2.1 未分配地址 
未分配地址是指尚未配置节点元素或尚未分配地址的地址，未分配地址的值应为0x0000，如图3.3所示。例如，可以通过将模型的发布地址设置为未分配的地址，禁用模型的消息发布。

![](https://github.com/fridyss/ble-mesh-note/blob/master/material/3_3%20unassigned%20address%20format.png)

*图3.3 未分配地址格式*

未分配的地址不得用于消息的源或目标地址字段。

#### 3.4.2.2 单播地址 
单播地址是分配给每个元素的唯一地址，单播地址的位15设置为0。单播地址不应是0x0000，因此可以为从0x0001到0x7FFF（包括0x7FFF）的任何值，如下面的图3.4所示。

如第5.4.2.5节所述，在配置期间，在网络上节点的生存期内，由provisioner将单播地址分配给节点的每个元素。provisioner可能未分配该地址，以允许使用过程重用该地址。过程定义 在3.10.7章节。

![](https://github.com/fridyss/ble-mesh-note/blob/master/material/3_4%20unicat%20address%20format.png)

*图3.4 单播地址格式*

单播地址应用于消息的源地址字段，也可用于消息的目标地址字段。发送到单播地址的消息最多由一个元素处理。
#### 3.4.2.3 虚拟地址 
虚拟地址表示一组目标地址，每个虚拟地址在逻辑上表示一个标签UUID，这是一个不必集中管理的128位值。一个或多个元素可以编程为发布或订阅标签UUID，标签UUID不能被传输，应作为上层传输层消息完整性检查值的附加数据字段（见第3.8.7节）。

虚拟地址是一个16位的值，它的位15设置为1，位14设置为0，位13~0设置为哈希数值。此哈希数值是标签UUID的派生，因此每个哈希表示多个标签UUID。

![](https://github.com/fridyss/ble-mesh-note/blob/master/material/3_4%20hash.png)

当接收到具有匹配哈希值的虚拟地址的访问消息时，作为身份验证的一部分，上层传输层将每个对应的标签UUID用作附加数据，在找到匹配项之前发送消息。
控制消息不可以使用虚拟地址。

标签uuid可以按照[8]中的定义随机生成，配置客户端可以分配和跟踪虚拟地址，然而两个设备也可以使用一些带外（OOB）机制创建虚拟地址。与组地址不同，这些可以由相关设备商定，而不是需要在集中配置数据库中注册，因为它们不太可能重复分配。

虚拟地址的一个缺点是，在配置期间，需要多段消息将标签UUID传输到发布或订阅节点。

虚拟地址可以是0x8000到0xBFFF之间的任何值，如下面的图3.5所示。

![](https://github.com/fridyss/ble-mesh-note/blob/master/material/3_5%20virtal%20adress%20format.png)

*图3.5 虚拟地址格式*

注意：当将32位MIC和哈希值的大小进行因式分解时，两个使用相同应用密钥但不同标签uuid的匹配虚拟地址发生冲突的可能性只有1/246=1.42×10-14。
#### 3.4.2.4 组地址 
组地址是编程为零个或多个元素的地址，组地址的位15设置为1，位14设置为1，如下图3.6所示。0xFF00到0xFFFF范围内的组地址保留给固定组地址（见表3.4），0xC000到0xFEFF范围内的地址通常可用于其他用途。

![](https://github.com/fridyss/ble-mesh-note/blob/master/material/3_6%20group%20address%20format.png)

*图3.6 组地址格式*

组地址只能在消息的目标地址字段中使用，发送到组地址的消息应发送到订阅此组地址的模型的所有实例。

有两种类型的组地址：可以动态分配的组地址和固定的组地址，如下表3.4定义了固定组地址。

| 值 | 固定组地址名字 |  
| --- | ---|
| 0xFF00 - 0xFFFB | RFU |  
| 0xFFFC | all-proxies |  
| 0xFFFD | all-friends |  
| 0xFFFE | all-relays |  
| 0xFFFF | all-nodes |  

*表3.4 固定组地址*

发送到“all-proxies”地址的消息应由所有使能了代理功能的节点的主要元素处理。

发送到“all-friends”地址的消息应由所有使能了好友功能的节点的主元素处理。

发送至“all-relays”地址的消息应由所有使能了中断功能的节点的主要元件处理。

发送到“all-nodes”地址的消息应由所有节点的主元素处理。

### 3.4.3 地址有效性
表3.5显示哪些地址类型在源地址字段和目标地址字段中有效。

![](https://github.com/fridyss/ble-mesh-note/blob/master/material/3_5%20Address%20type%20and%20message%20field%20validity.png)

*表3.5 地址类型和消息的有效性*

表3.6显示了哪些地址类型可与设备密钥和应用程序密钥一起使用。

| 地址类型 | 与设备密钥的有效性 | 与应用密钥的有效性 |
| --- | --- | --- |
| 未分配地址 | NO | NO |
| 单播地址 | YES | YES |
| 虚拟地址 | NO | YES |
| 组地址 | NO | YES |

*表3.6 地址类型和访问层密钥类型有效性*

### 3.4.4 网络PDU
mesh "NetWork PDU"格式见表3.7，如下图3.7所示：

| 字段 | 位 | 备注 |
| --- | --- | --- |
| IVI | 1 | IV Index 最低位有效 |
| NID | 7 | 派生于NetKey, 用于标识"加密密钥"和"用于保护NetWork PDU私密密钥 |
| CTL | 1 | 网络控制 |
| TTL | 7 | 存活时间 |
| SEQ | 24 | 序列号 |
| SRC | 16 | 源地址 |
| DST | 16 | 目标地址 |
| transportPDU | 8~128 |transport Protocol Data Unit |
| NetMIC | 32~64 | 网络消息完整性 |

*表3.7 NetWork PDU 字段定义*

“NetWork PDU” 被使用从单个网络密钥派生的密钥（由NID字段标识）安全保护着。

![](https://github.com/fridyss/ble-mesh-note/blob/master/material/3_7%20NetWork%20PDU%20format.png)

*图3.7 NetWork PDU 格式*

#### 3.4.4.1 IVI
IVI字段包含IV引索的最低有效位，用于验证和加密此 "NetWork PDU"（请参阅第3.8.3节）。
#### 3.4.4.2 NID
NID字段包含一个7位网络标识符，允许更容易地查找，用于验证和加密此"NetWork PDU"的加密密钥和私钥（请参阅第3.8.6.3.1节）。
NID值与加密密钥和私钥一起从网络密钥派生，对于“主要网络消息”和“友元与其低功耗节点之间的专用网络消息”，其派生方式不同（请参见第3.8.6.3.1节）。
#### 3.4.4.3 CTL
CTL字段只有一个bit，该bit用于确定消息是控制消息还是访问消息的一部分，如表3.8所示。

1. 如果CTL字段设置为0，则NetMIC为32位值，"transportPDU"包含的是访问消息。
2. 如果CTL字段设置为1，则NetMIC为64位值，"transportPDU"包含的是控制消息。


| CTL 字段 | 消息类型 | NetMIC大小（bits） |
| --- | --- | --- |
| 0 | 访问消息 | 32 |
| 1 | 控制消息 | 64 |

*表3.8 CTL 字段类型和NetMIC大小*

#### 3.4.4.4 TTL
TTL字段是一个7位字段。定义了以下值：

1. 0 = 未中继且不会中继。
2. 1 = 可能已中继，但不会中继。
3. 2~126 = 可能已中继且可以中继。
4. 127 = 未中继且可以中继

该字段的初始值由发送层（下传输层、上传输层、访问层、基础模型、模型）或 应用来设置，并在作为中继节点运行时由网络层使用。

TTL值为0是的作用是允许节点传输一个它知道不会丟失的"NetWork PDU", 因此，接收节点可以确定发送节点是一个单广播无线链路。
TTL值为1或者比1大的作用不能用来做这样的决定。

#### 3.4.4.5 SEQ
SEQ字段是24位整数。,对于元素发起的每个新"NetWork PDU"，SEQ字段、IV Index字段和SRC字段（见第3.4.4.6节）的组合都应该是唯一的值。
#### 3.4.4.6 SRC
SRC字段是一个16位值，用于标识发起此"NetWork PDU"的元素。该地址类型应为单播地址。

SRC字段由发起元素设置，并且被作为中继节点原封不动地转发。

#### 3.4.4.7 DST
DST字段是一个16位值，用于标识此"NetWork PDU"指向的一个或多个元素。此地址应为单播地址、组地址或虚拟地址。

DST字段由发起节点设置，并且在不受网络层中作为中继节点的影响。

#### 3.4.4.8 TransportPDU
从网络层的角度来看，“TransportPDU”字段是一个八位字节的数据队列。当CTL位为0时，“TransportPDU”字段的最大值应为128位。当CTL位为1时，“TransportPDU”字段的最大值应为96位。

“TransportPDU”字段由发起者的下层传输层设置，而且不应被网络层更改。

#### 3.4.4.9 NetMIC
NetMIC字段是一个32位或64位字段（取决于CTL位的值），用于验证DST和TransportPDU没有被更改。

当CTL位为0时，NetMIC字段应为32位。当CTL位为1时，NetMIC字段应为64位。

NetMIC由每个传输或中继该“TransportPDU”的节点的网络层设置。

### 3.4.5 网络接口
网络层支持通过多个承载器发送和接收消息。承载的多个实例可以存在，承载的每个实例通过网络接口连接到网络层。为了允许在同一节点内的元素之间发送消息，使用本地接口。

例如，一个节点可以有三个接口：
1. 一个用于通过广告承载发送和接收消息的接口。
2. 两个GATT承载接口, 每个客户端连接都通过GATT连接。

接口提供输入和输出过滤器，过滤器可以使用 "特定于承载PUD"进行配置，也可以由在节点上公开的服务进行内部配置，例如Mesh代理服务（参见第7.2节）。

#### 3.4.5.1 输入过滤接口
输入过滤接口器决定是否将传入的Mesh消息传递到网络层，并进行进一步处理，或者是否将其丢弃。
#### 3.4.5.2 输出过滤接口
输出筛选器接口决定传出的Mesh消息是传递给承载者还是丢弃，连接到“广播承载”或“GATT承载”的输出滤波器的接口，应丢弃TTL值设置为1的所有消息。
#### 3.4.5.3 本地网络接口
本地网络接口允许在同一节点内的元素之间发送消息，节点应实现本地网络接口，通过本地网络接口接收消息后，应将本条消息传递到节点的所有元素。
#### 3.4.5.4 广播承载网络接口
广播承载网络接口允许使用广播承载发送消息（见第3.3.1节）。

1. 从网络层接收到未标记为中继的“NetWork PDU"时，广播承载网络接口应使用网络传输状态的值, 在广播承载上重传“NetWork PDU",（见第4.2.19节）。

2. 当从网络层接收到标记为中继的“NetWork PDU"时，广播承载网络接口使用中继重传状态的值，在广播承载上重传网络PDU（参见第4.2.20节）.

### 3.4.6 网络层行为
#### 3.4.6.1 中继特性
中继特性用于中继/转发由节点通过广播承载接收的“NetWork PDU"，此功能是可选的，如果支持，可以启用和禁用。如果代理特征得到支持，则GATT承载和广播承载都应得到支持。
#### 3.4.6.2 代理特性
代理特性用于中继/转发”GATT“和”广播承载者“之间的节点接收到的“NetWork PDU"。此功能是可选的，如果支持，可以启用和禁用。支持此功能时，在"Mesh Proxy Service"公开（参见第7.2节）。
#### 3.4.6.3 接收一个网络PDU
消息通过网络接口从承载者传送到网络层，该接口应采用其输入过虑器定义的过滤规则（见第3.4.5.1节）。如果消息通过输入过滤器，则将其传递到网络层以进行进一步处理。

接收到的每个网络PDU都可以用附加的元数据进行标记，这些元数据可在以后用于更改此消息的处理。

接收到消息后，节点应检查NID字段值是否与一个或多个已知的NID字段值匹配。如果NID字段值与已知的NID不匹配，则应忽略该消息。如果NID字段值与已知的NID匹配，则节点应根据匹配的每个已知网络密钥对消息进行身份验证。如果消息没有根据任何已知的网络密钥进行身份验证，则应忽略消息。如果消息确实根据网络密钥进行身份验证，则SRC和DST字段被视为有效（见第3.4.3节），并且消息不在网络消息缓存中（见第3.4.6.5节），则消息应由下层传输层处理。

如下议定义，当消息被重新传输时，重发时使用的"IV Index"应与接收时使用的"IV Index"相同。

1. 如果从广播承载传送的消息被下层传输层处理，则节点支持中继性并且开启，TTL字段值应为2或者比2更大的值，如果目的地址不是该节点上的元素的单播地址，则则TTL字段值应减去1, “NetWork PDU"应标记为中继，“NetWork PDU"应重新传输到连接到广播承载的所有网络接口。建议在接收“NetWork PDU"和中继“NetWork PDU"之间引入小的随机延迟，以避免多个中继之间同时接收“NetWork PDU"的碰撞。

2. 如果从GATT承载发送的消息被下层传输层处理，则节点应支持代理功能并且开启，并且TTL字段的值为2或更大，并且目的地址不是该节点上的元素的单播地址，则TTL字段的值应减去1，“NetWork PDU"应重新传输到所有网络接口。

3. 如果从广播承载传送的消息被下层传输层处理，则节点应支持代理功能并且开启，并且TTL字段的值为2或更大，则目的地址不是此节点上元素的单播地址，则TTL字段应减去1，并且“NetWork PDU"应重新传输到连接到GATT承载的所有网络接口。

图3.8说明了传入“NetWork PDU"的处理步骤示例：

![](https://github.com/fridyss/ble-mesh-note/blob/master/material/network%20PDU%20proccess%20steps.jpg)

*图3.8 NetWork PDU处理步骤实例*

#### 3.4.6.4 发送一个网络PDU
消息被mesh子网上下文中的元素传输，mesh子网由唯一的网络密钥标识。

* IVI字段应设置为用于为mesh子网传输的"IV Index"值的最低有效位。
* NID字段应设置为与加密密钥和私钥相关的NID值，这两个密钥用于加密和混淆。
* CTL字段应由更高层设置。
* TTL字段应由更高层设置。
* SEQ字段应由网络层设置为元素的序号。然后，对于每个新的网络PDU，序列号应增加一个。
* SRC字段应由网络层设置为元素的单播地址。该元素是用来发送 "NetWork PDU"。
* DST字段应设置为单播地址、组地址或虚拟地址，以标识一个或多个目标元素，并应由下传输层、上传输层或访问层设置。
* TransportPDU字段应由更高层设置。
* NetMIC字段应按照第3.8.7.2节的规定设置。

消息应传送到所有网络接口。每个接口应采用其输出过滤器定义的滤波规则（见第3.4.5.2节）。如果 "NetWork PDU"通过输出过滤器，则应在承载上传输。
#### 3.4.6.5 网络消息缓存
为了减少不必要的安全检查和过度中继，节点应包括所有最近看到的"NetWork PDU"的网络消息缓存。如果接收到的"NetWork PDU"已经在网络消息缓存中，则不应处理该"NetWork PDU"，应立即丢弃。如果接收到"NetWork PDU"，且该"NetWork PDU"不在网络消息缓存中，则可以处理该"NetWork PDU"（例如，检查网络安全性），如果该"NetWork PDU"是有效的"NetWork PDU"，则应将其存储在网络消息缓存中。

节点不需要缓存整个网络PDU，并且可以仅缓存其一部分以进行跟踪，例如NetMIC、SRC/SEQ或其他值。

当网络消息缓存已满，且需要缓存传入的"NetWork PDU"时，传入的新"NetWork PDU"应替换已在网络消息缓存中的最旧"NetWork PDU"。

网络消息缓存应能够存储至少两个网络pdu，尽管强烈建议定义网络消息缓存大小，应该根据与预期网络密度来定义 。
