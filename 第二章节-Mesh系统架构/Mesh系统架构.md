# 2 MESH系统架构
这一章节，主要提供了对mesh网络操作和分层的系统架构的概述。
## 2.1分层的架构
mesh文档规范被定义为一个分层的架构如图2.1所示。

![](https://github.com/fridyss/ble-mesh-note/blob/master/material/mesh%20system%20arhitecture.png)

*图2.1 mesh 系统架构
### 2.1.1 模型层
模型层定义模型是被用于标准化典型用户场景的操作，并且被定义在蓝牙Mesh模型规范中，或者其他高层规范中，例如，高层模型规范包括了灯光模型和传感器模型。
### 2.1.2 基楚模型层
基楚模型层，定义了管理和配置mesh网络所需的状态，消息，模型。
### 2.1.3 访问层
访问层，定义了高层应用如何使用上层传输层，定义了应用数据的格式，定义和控制在上层传输层执行的应用数据加密和解密。并且检查传入来的应用数据是否在正确的网络密钥和应用密钥上下文中被接收到，然后转发到更高层。
### 2.1.4 上层传输层
上层传输层可以对应用数据进行加密，解密，认证，被设计用于访问消息提供机密性。 同时，也定义在节点之间如何传输控制消息用来管理上层传输层，包括使用友元特性的情况
### 2.1.5 下层传输层
 下层传输层定义，如何将上层传输层消息分段和重组成多个下层传输PDUs, 为了将分发大的上层传输消息到其他节点。同时，也定义了一个信令控制消息去管理分段和重组。
### 2.1.6 网络层
网络层定义如何传输消息定位到一个或多个元素，定义了网络消息格式可以允许由承载层传输PDUs，网络层定义了是否中断/转发消息，接受并进一步处理，或者拒绝他们，同时也定义了网络消息如何加密和认证。
### 2.1.7 承载层
承载层定义了网络消息如何在节点之间传输，目前有两个承载层，分别为广播承载，GATT承载，以后或者会定义更多的承载层。
## 2.2 MESH操作概述
 协议规范定义mesh网络操作如下 ：

* 允许消息可以从一个元素发送到一个或者多个元素。
* 允许消息可以通过其他节点中转，从而扩展通信范围。
* 安全消息已知的安全攻击，包括 “窃听攻击”，“中间人攻击”，“中断攻击”，“暴力破解攻击”，“垃圾桶攻击”。
* 可以工作市场上现有的设备工作。
* 及时发送消息。
* 当一个或者多个设备被移除或者停止，可以继续工作，而且兼容以后的规范文档。

该规范定义了基于泛洪管理（managed-flood-based）的Mesh网络，该网络使用广播信道传输消息，以便其他节点可以接收消息并转发这些消息。从而扩大原始消息的范围。只要有足够密度的设备监听和中继消息，受管理的泛洪（managed-flood）Mesh网络中的任何设备都可以随时发送消息。增加路由功能和定义基于路由的Mesh网络的增强可以考虑用于本规范的未来版本。

本规范使用多种方法来限制受管泛洪Mesh网络中消息的无限中继。使用的两种主要方法是网络消息缓存（network message cache）方法和生存时间（time to live）方法。

网络消息缓存通过添加所有消息到缓冲列表以防止中继以前接收的消息。当收到消息时，会根据列表进行检查，如果已经存在则忽略。如果没有收到，则将其添加到缓存中，以便将来可以忽略它。为了防止这个列表变得太长，缓存的消息数量受到实际的限制。

每条消息都包含一个生存时间（TTL）值，用于限制消息中继的次数。每次收到一条消息，然后由设备中继（最多126次），TTL值就会减1。

### 2.2.1 网络和子网
mesh网络由共享4种资源的节点组成：

* 网络地址，用于标识源消息和目标消息（参考3.4.2章节）。
* 网络密钥，用于在网络层保护和认证消息（参考3.8.6.3章节）。
* 应用密钥，用于在访问层保护和认证消息 （参考3.8.6.2章节）。
* IV索引，用于延长网络的生命时间。（参考3.8.4章节）

网络可以有一个或者多个子网，从而形成区域的隔离，例如，酒店房间子网隔离酒店网络。子网是一组在网络层可以互相通信的节点，因为它们共享一个网络密钥。一个节点通过拥有一个或者多个网络密钥，可以属于一个或者多个子网。当配置的时候，一个设备被配置到一个子网，并且可以使用配置模型添加到更多的子网中去。

有一个名叫主子网的特殊子网，基于主网络密钥（Primary NetKey）（参考3.8.6.4章节）, 主子网的节点参与 IV 更新（IV Update）规程 （参考3.10.5章节），并且传播 IV 更新到其他子网，而其他子网IV更新只能在所属子网进行。

网络资源由实现"配置客户端模型（Configuration Client model）"的节点管理，称为配置客户端。（通常指智能手机或者可移动计算机设备），并且在配置时分配节点，配置时使用配置服务模型（ Configuration Server model），特别地，配置者管理分配地址，确保没有重复的单播地址被分配，然而，配置客户端生成和分发网络密钥和应用密钥，确保需要相互通信的设备为网络和访问层共享适当的密钥，配置客户端也知道设备密钥（devcie key）(参考3.8.6.1)，用于保护与每个单独节点的通信，包括分发更新的网络和应用程序密钥。

### 2.2.2 设备和节点 
不是mesh网络成员的设备被称为未配置设备（unprovisioned device）, 是mesh网络成员的设备被称为节点（node）。配置者（provisioner）是用于管理 “未配置设备” 与 “节点”之转换。

“未配置设备” 不可以收发mesh消息，然而，它会通过广播告知“配置者”它的存在，通过认证后，“配置者”将会发出邀请给“未配置设备”，请求加入mesh网络，从而将“未配置设备”转变成“节点”。

“节点”可以收发mesh消息，并且由“配置客户端”管理，配置客户端也可能与“配置者”是相同的设备。通过Mesh网络来配置节点与其他节点的通信方式。“配置客户端”可以从Mesh网络中删除一个节点，这将该节点恢复为“未配置的设备”。

设备可以通过在已经配置到Mesh网络之后，将其自身提供给另一个Mesh网络来支持节点的多个实例。Mesh网络的每个实例都由设备在配置期间获取的地址和设备密钥确定。

### 2.2.3 添加设备到mesh网络
设备由“配置者”添加到mesh网络中，成功配置后，设备就变成了“节点”。这个过程和“蓝牙无线技术”中的点对点绑定和配对是不相同的。 配置设备可以被使能，主要通过“广播承载”或者 “GATT承载”。两个承载使用一个独立的配置协议。通过基于所有实现“广播承载“的设备进行配置，通过基于”GATT承载“来配置，允许诸如传统手机设备成为”配置者“。

为了协助配置多个设备，设备有一个”关注计时器（attention time）“, 计时器由”配置者“设置。 当这个值被设置为非0时，设备使用任何可能的方式识别自己，例如，设备可以”闪灯“，”发出声音“，”振动“，当时间到来，设备就会停止标识自己。同时允许”配置者“发送单个消息到设备，以至识别自己，并且在给定时间后，设备会自动停止识别自己。

在这两个承载上运行的协议，是蓝牙核心规范v4.2的安全管理器协议的衍生，用于引入验证具有非常有限的用户界面的设备（如灯泡或交换机）的能力。安全管理器协议需要可靠的Bearer，这是广播配置承载不能保证的。因此本规范中使用的协议旨在实现与承载无关的可靠消息传递。与安全管理器协议的相似性可以在已实现此功能的设备上大量重用现有代码

### 2.2.4 通讯支持 

在未更新情况下，许多当前设备不能发广告或理解Mesh消息。为了使这些设备能够与Mesh网络中的节点进行通信，而无需进行操作系统更新或类似的硬件/软件更新，该规范支持对所有现有设备可以使用GATT连接。

### 2.2.5 低功耗支持 

本规范中的特性使Mesh网络中的许多设备可以使用电池供电，或使用诸如能量采集等技术。这些设备可能受限于它们如何用作Mesh网络的一部分（例如，与之交互时仅发送数据的设备）。本规范不要求设备协调传输，建立连接或在每个连接上重新启动安全性;从而促进低功耗操作。需要低功耗支持的设备可以使用称为“友元（Friendship）”的概念（参考 3.6.6 章节 ） 将自己与始终在线的设备相关联，该设备代表它们存储和中继消息 。然而，中继消息的设备大多数时间都会接收消息并转发消息，并且可能使用的功耗要比典型的小电池或电容器提供的功耗大得多。

## 2.3 架构概念
mesh网络架构使用了几个不同的概念： 状态（state），消息（message）,绑定（bindings）, 元素（elment）,寻址 (addressin)，模型（models）,发布-订阅（publish-subsribe）,mesh 密钥（mesh key）,关联（associations）。
### 2.3.1 状态
状态是表示元素条件状态的值.

公开状态的元素被称为服务，例如，最简单的服务是“通用开关服务（Generic OnOff Server）”, 表示灯的开关两种状态。访问状态的元素被称为客户，例如，最简单的客户是“通用开客户（Generic OnOff Client）”, 二进制开关，它能够通过通用开关模型（Generic OnOff Model）定义的消息来控制“通用开关服务”。

由两个以上的值组成的状态称为组合状态，例如，变色灯可以分别通过“色彩饱和度”和“亮度”控制色调。

### 2.3.2 绑定状态

当一个状态被绑定到另一个状态时，一个状态的变化会导致另一个状态的变化。绑定状态可能来自一个或多个元素中的不同模型。例如，一个常见类型的绑定是“级别状态”和“开关状态”, 将“级别状态”更改为0, 会将绑定的“开关状态”更改为Off，反之，非0则会将绑定的“开关状态”更改为On。

### 2.3.3 消息

在Mesh网络中的所有通信都是通过发送消息来完成。消息操作是基于状态的。对于每个状态，都有一组定义Server 支持的消息，并且Client可以使用该消息，请求状态值或更改状态。Server也可以传输未经请求的消息, 其中包含关于 “状态”和/或 “改变状态”的消息。

消息被定义为具有“操作码”，“相关参数”和“行为”。一个操作码可以是一个单字节（特殊消息，需要最大可能的有效参数负载），2个字节（标准消息），或者3个字节（供应商特定的消息）。

总消息大小（包括操作码），主要由下层传输层确定，其可以使用分段和重组（SAR）机制。为了最大化地提高性能，并且避免SAR的开销，设计目标是将消息放入单个段中。传输层为非分段消息最多提供11个字节，当使用1个字节操作码时，最多可以保留10个字节可用于参数，同理，当使用2个字节操作码时，最多可以保留9个字节可用于参数，当使用3个字节操作码时，最多可以保留8个字节可用于参数。

传输层提供了一个能够传输多达32个段的SAR机制。使用SAR时的最大消息大小是384个字节。这意味着（排除一个应用加密完整性MIC），当使用1个字节操作码时，最多可以保留379个字节可用于参数。当使用2个字节操作码时，最多可以保留378个字节可用于参数。当使用3个字节操作码时，最多可以保留377个字节可用于参数。

在每个分段的访问层负载上，SAR不会施加任何额外的开销, ：一个10字节的消息作为未分段的消息传输，而20个字节的消息作为使用两个分段的分段消息传输。

消息定义包含参数表。在消息有效负载中，参数跟随操作码，如果没有特殊说明，参数偏移量以字节为单位。

消息被定义为“应答”或“无应答”两种。“应答”消息需要响应，然面“无应答消息”不需要响应。

### 2.3.4 元素
元素是节点内的可寻址实体。每个节点至少有一个元素，主要元素，并可能有一个或多个额外的“次要元素”。元素的数量和结构是静态的，并且元素在节点的整个生命周期中都不能改变（只要该节点是网络的一部分）。

在节点配置期间，节点的第一个单播地址（unicast address）被用于寻址主要元素，每个附加的次要元素使用随后的地址进行寻址。
这些单播元素地址允许节点识别，用于传输或接收消息。

如果元素的数量和结构发生变化，例如，由于固件更新，则必须重新被设备配置成节点。当执行“更改元素数量或结构”的固件更新时，将使用 “节点移除”规程（参考 3.10.7 章节 ）。

消息在基于操作码和元素地址的模型内分派。

一个元素不允许包含多个使用了“相同方法”或“相同消息”模型实例，（例如，接收“On”消息）。当同一元素中的多个模型使用相同的消息时，这些模型被称为“重叠”。为了在单个节点内实现多个重叠的模型实例。（例如，控制可以打开和关闭的多个灯具），该节点需要包含多个元素。

例如，灯具可能有两个灯泡，每个灯泡实现“Light Lightness Server”模型的实例和“Generic Power OnOff Server”模型的实例。这要求节点包含两个元素，每个灯泡一个。当它收到“开启”消息时，该节点使用元素的单播地址来标识该消息，从而寻址到具体那个“通用开关服务器”模型的实例。

另一个示例，双插槽电源板包含两个独立的能量测量传感器，可以测量连接到插座上的设备消耗的功耗。这将要求节点具有两个传感器数据状态，每个状态都在一个单独的元元素中。第一个元素，即主要元素，将使用该节点的单播地址进行标识，并且将包含第一个能量传感器的状态以及表示节点配置的状态。第二个元素，即次要元素，将使用单播元件地址进行识别，并将包含第二个能量传感器的状态。

每个元素都有一个GATT蓝牙命名空间描述符值，有助于识别此元素所代表的是节点的哪一部分。这些名称空间描述符值使用与GATT相同的定义。例如，温度传感器的元素将使用“内部”和“外部”的值


### 2.3.5 地址

地址可以是“单播地址（unicast address）”，“虚拟地址（virtual address）”或“ 组地址（group address）”。还有一个特殊的值来表示“未被分配的地址”（unassigned address），未被分配的地址在消息中不能使用。

单播地址被分配给一个元素，并且总是表示一个单元素的节点。每个Mesh网络有32767个单播地址。

虚拟地址是多播地址，可以表示一个或多个节点上的多个元素。每个虚拟地址在逻辑上代表一个标签UUID，它是一个不需要集中管理的值，大小为128位，。每个发送到标签UUID的消息，在消息完整性检查值中包含完整的标签UUID，被用于消息验证。为了减少检查每个已知标签UUID的开销，使用标签UUID的哈希值。有16384(2^15)个哈希值，每个哈希值编码一组虚拟地址。虽然在虚拟地址中仅使用16384(2^15)个哈希值，但每个哈希值可能代表数百万个可能的标签UUID。因此，虚拟地址的数量被认为是非常大的。

组地址是多播地址，可以表示一个或多个节点上的多个元素。每个Mesh网络有16384(2^15)个组地址。有一组固定组地址，用于定位节点的所有主要元素的子集。所有其他组地址都称为动态分配的组地址。有256个固定组地址和16128个动态分配的组地址。

### 2.3.6 模型

模型定义了节点的基本功能。一个节点可能包含多个模型。模型定义了所需的状态，消息，行为。

mesh应用是使用“ client-server ”架构，主要用到“发布-订阅”这种模式。由于Mesh网络的特性，以及对配置客户端执行的行为配置的识别，因此应用未在单个端到端规范（如配置文件）中定义。相反，应用是在“客户端模型”，“服务器模型”和“控制模型”中定义的。

本规范定义了三种类型的模型：“服务器模型”，“客户端模型”和“控制模型”：

* 服务器模型：服务器模型由一个或多个状态组成，每个状态可以分解成一个或多个元素，服务器模型定义了一组可以收发的强制性消息。收发消息是元素所需的行为，以及在发送或接收消息之后发生的任何其他行为
* 客户端模型：客户端模型定义了一组客户端的消息（包括必需的和可选的） 用于请求，更改或使用由服务器模型定义的相应服务器状态。而且客户端模型没有状态。
* 控制端模型： 控制模型可能包含客户端模型功能，以及服务器模型功能。控制模型也可以包含 控制逻辑 ， 控制逻辑是协调控制模型连接的其他模型之间的交互作用的一组规则和行为。

单个设备可能包括服务器，客户端和控制模型。

例如， 图2.2 显示了一个设备的元素模型结构，实现具有状态并支持消息R，S，T，X，Y，Z的服务器模型（设备C）。以及两个实现客户端模型的设备，设备A支持消息X，Y和Z，设备B支持消息R，S，T和Z。
![]()
*图2.2 clien-server 模型通信*

例如，图2.3显示了具有元素结构设备，实现了一个控制模型，设备C可以作为client与server模型通信，主要是通过消息 X, Y, Z, R, S, T, 也可以作为server与client模型通信，server主要支持消息A, B, C  。
![]()

*图2.3 控制模型通信*


照明控制器是一个实现“控制模型”的实例，照明控制器需要起到client的作用，可以作为传感器和光源，传感器用于测量“占用率”和/或“环境光”，光源则为灯泡或者其他照明设备。照明控制器还可以作为设置客户端的服务器（例如配置其参数的智能手机应用）。这样的照明控制器可以包括在“传感器”或“光源”，或它可以是单独的设备。

模型可以将设备的功能定义为网络节点，如密钥管理，地址分配和消息中继。模型还定义设备的物理行为，如功耗控制，照明控制和传感器数据收集。可能有节点仅实现与网络相关的功能，例如中继节点或代理节点，而大多数节点能够通过控制电力，控制光发射或感测环境数据来与物理世界交互。

消息可以被多个不同的模型使用。每个模型中的消息行为都是相同的，因此可以在客户端，服务器和控制模型之间达成共识，因为无论发送和处理消息的模型如何，其行为都是一致的。

模型规格设计得非常小巧且独立。在规范定义时，模型可能需要在同一节点内实例化其他模型。这称为扩展 ，这意味着模型可以扩展其他模型。不能扩展为其他模型的模型，被称为根模型 。

模型规范是不可变的：不可能删除或者向模型添加行为，无论这个行为是“可选行为”还是“强制行为”。模型没有版本并且没有特征位。如果模型中需要额外的行为，则定义一个新的扩展模型，该模型公开所需的行为，并且可以与原始模型一起实现。

因此，知道元素所支持的模型，就知道了该元素所暴露的确切行为。

模型可能由“蓝牙SIG”定义并采用，也可能由供应商定义。”蓝牙SIG“定义的模型被称为“SIG采用的模型”，供应商定义的模型被称为供应商模型。模型由唯一的标识符标识，“SIG采用的模型”是16位，供应商模型是32位。

例如， 图2.4 显示了一个设备的元素模型结构，设备实现了具有两个绑定状态的根模型，每个状态下都有一组可运行的消息。根模型位于“主要元素”内，并由扩展模型进行扩展，而且在“次要元素”上添加另一个状态（X2）。<u>消息不能区分同一元素上同一状态的多个实例</u>。因此，当设备上存在多于一个给定状态的实例时，每个实例都需要位于一个单独的元件中。在这个例子中，状态X的第二个实例需要位于第二个元件上，因为它是一个相同类型的状态，因此具有相同类型的消息
![]()
*图2.4 设备的元素模型结构*

此示例结构可能会在复合设备中有多个。例如，复合设备可能有多个相同根模型（或扩展模型）的实例，每个实例都在一个单独的元件（或一组元件）上。另外，如果一个模型（根或扩展）需要一个特定状态的多个实例，该状态必须分布在多个元素上，以至于任何给定状态的单个实例至多在一个元素上。

图2.5说明图2.4设备的元素模型结构如何可能被执行在一个复合设备中。该装置的元素模型结构是由组合数据 ， 其由配置客户端部署后读，使用配置服务器模型和配置客户端模型。

![]()

*图2.5 复杂设备的元素模型结构*

### 2.3.7 案例设备

为了帮助解释模型在元素中的排列是如何决定设备的状态和行为，我们将使用双插槽智能电源板设备（如图 2.6 所示 ） 作为示例。该设备具有蓝牙低功耗的单一无线电和两个独立的电源插座，每个电源插座都可控制功率输出。这个例子包括状态，消息和模型 。
![]()
*图2.6 双插槽智能电源板*

该设备有两个元素(参见2.3.4节)，分别代表两个电源插座。每个元素都有一个分配给它的单播地址。

每个元素的功能由“ Generic Power Level Server ”模型定义。该模型定义了一组服务器上的状态，以及定义一组操作状态的消息。

“Generic Power Level Set”消息可以被发送到设备以控制功率输出。该消息被发送到一个元素，并在目标地址（DST）字段域携带该元素的地址（参考2.3.8 章节 ）。

插槽也可以通过实现“Generic Level Client”模型的通用设备（如调光器）进行控制（并且不知道任何有关功率控制的内容）。该模型简单地将期望等级设置为0~最大值。通过状态绑定来控制插座的功率。在每个电源插座中，“通用功率实际状态”都绑定到“通用等级状态”。“通用等级客户端”将“通用级消息”发送到“通用级服务器”。通用级别状态发生改变，然后改变“通用功率实际状态”。

元素可以报告状态。在我们的例子中，每个插座可以报告功率等级，以及插入插座的设备的功耗。使用“Sensor Server”模型定义的消息来报告功耗。每个消息的SRC字段中都有元素的地址，用于标识插槽（参考 3.4.4.6 章节 ） 。

图2.7 说明 双插槽设备的元素模型结构。功能上，备具上元素有相同的特征。唯一的区别是除了其他模型之外，主要元件还处理用于网络管理的“Configuration  Server”模型。每个元素可以定义其他模型，如“Health Server”模型（参考  4.4.4 章节 ）或 Mesh Model模型规范中定义的模型 。
![]()

*图2.7  双插槽智能板的元素模型结构*

### 2.3.8 发布-订阅 和 消息交换

mesh网络内数据的发布和订阅说明了使用“发布 - 订阅”模式。生成消息的节点将发布消息到单播地址，组地址或虚拟地址。如果有兴趣接收消息，则节点可以订阅这些地址。

生成的消息被发送到的目标Mesh地址，这些地址可以是单播，预先配置的组地址或虚拟地址。消息可以作为其他消息的回复信息，也可以是未经请求的消息。当模型的实例发送回复消息时，它将传入消息”源地址“用作“目标地址”。当模型的实例发送未经请求的消息时，它将使用“模型发布地址”作为“目标地址”。节点中的每个模型实例都有一个单独发布地址。

在接收这边，节点内部的每个模型的实例可以订阅一个或多个组地址或虚拟地址。无论任何时候，消息被发送到组地址或虚拟地址时，
地址在模型预订列表，每当消息到达时，该消息都将由该节点处理。当目标地址是接收元素的单播地址，或目标地址是该设备所属的固定组地址时，也会处理该消息。如果一个节点有多个元素，那么该消息在被寻址的每个元素上处理一次。

模型的“发布地址”和“订阅列表”主要由高层规范协议定义，它们的状态使用主要由“Configuration Server” 模型管理。

节点可以为模型元素的每个实例拥有任意数量的订阅，尽管节点可能会限制支持的订阅数量。使用多个订阅地址允许节点响应发布到不同组的消息。例如，灯可以订阅发送到 “床头灯组”，“卧室组”，“楼上组”和“家庭组”的消息。

每条消息都从一个单播地址（一个元素地址）发送，并使用唯一的序列号进行排序，以便检测和防止重放攻击。

### 2.3.9 安全

所有消息都使用两种密钥进行加密和验证。

1. 一种密钥类型用于网络层通信，使得Mesh网络内的所有通信都将使用相同的网络密钥。
2. 另一种密钥类型用于应用程序数据。分离网络和应用的密钥允许将敏感访问消息（例如，用于建筑物的访问控制）与非敏感访问消息（例如，用于照明）分开。Mesh网络中没有未加密或未认证的消息。


#### 2.3.9.1 应用安全和网络安全

在上层传输层和网络层对消息加密和认证的消息，目的是保护Mesh网络内的安全通信，防止窃听和恶意攻击。每层拥有不同的密钥，以便应用程序和网络接口之间的分离。

从网络密钥中分割应用密钥可实现应用消息的安全中继：中继节点可以在网络阶段对消息进行验证，而无需访问应用数据。例如，作为中继节点的灯泡应该无法打开门。

这意味着，无需知道应用密钥, 也可以通过从网络密钥派生的密钥，从而节点可以中断访问消息。 因此他们将没有能力更改或理解应用数据。在网络中的许多节点广泛知道网络密钥存在，从而增加中继节点的密度，同时保护不同的应用区域。这需要为每个应用分配密钥。例如，敏感的门安全应用将与非敏感的门铃和照明应用分开。

”应用密钥“直接与”关联的应用密钥标识符“一起使用，该标识符在特定上下文中用于标识所使用的应用。但是，网络密钥总是通过密钥派生函数来生成其他直接使用的密钥。这类密钥的包括”加密密钥“和”私密密钥“。这允许更改单个网络密钥，且所有从此密钥导出的相关值都能被快速导出。与应用密钥一样，网络密钥也用于派生网络密钥标识符（参考 3.8.6 章节 ）。

安全模型定义了三个单独的密钥 ”DevKey“，”AppKey“和 “NetKey”来加密消息。当节点被赋予一个密钥时，它被授权使用该密钥。密钥在多个节点之间共享，表示拥有相同密钥的节点，可以在节点之间收发消息。

“设备密钥”有助于在配置客户端和单个节点之间对密钥材料信息进行机密性和身份验证。“应用密钥”有助于在预定节点之间发送的应用数据的机密性和身份验证。“网络密钥”便于网络消息的隐私性，机密性和真实性。节点可能具有单个设备密钥，多个应用密钥和多个网络密钥的知识。

“设备密钥”类似于应用密钥，因为它的设计目的是保护在上层传输层中的应用发送的信息。但是，设备密钥仅由 “Configuration Client”和 “单个节点”知道。”Configuration Client“知道所有节点的设备密钥，”Configuration Client“通过发送这些由节点的设备密钥保护的密钥，从而安全地将密钥分发到一组节点。允许密钥分发只针对那些需要知道的节点。设备密钥的使用旨在防止“垃圾桶（trash-can）”攻击（一种从丢弃的设备中检索信息的技术，可用于对网络执行攻击），方法是允许仅限选定的设备分发新的网络和应用密钥。

应用程序密钥只能与单个网络密钥一起使用。这意味着网络密钥有一个或多个与其关联的应用密钥。这种关联被称为密钥绑定。

访问层安全的粒度基于每个模型。每个服务器模型（server model）都有一组绑定的应用程序密钥，定义可能的密钥，这些密钥应该用于加密和认证消息，而这些消息由模型的处理。这允许多个实体操作某些节点功能。最多可以将251个应用程序密钥绑定到模型。例如，"Light Lightness Server"模型有三个密钥绑定到它，因为管理员，用户和来宾都可以打开灯光。但是，只有管理员可以配置灯具，因此”Configuration Server Model“只存在”管理应用密钥“绑定到它。

#### 2.3.9.2 混合机制

网络安全模型利用称为混合的隐私机制，该机制利用AES通过私钥对 ”源地址“，”序列号“和”其他头信息“进行加密。混合的目的是使节点跟踪更加困难。

#### 2.3.9.3 网络密钥和应用密钥的标识符

一个节点可能有多个 ”网络密钥“或 ”应用密钥“。通过使用密钥标识符，可以识别用于保护消息的密钥子集。例如，节点可能只需要检查密钥标识符具有相同最低有效位的两个密钥，而无需检查20个密钥。如果收到的消息中有一个未知的密钥标识符，则该节点可以立即丢弃该消息。

密钥标识符是”网络密钥“ 或 ”应用密钥“使用密钥派生函数生成的 。该规范为”网络密钥“和”应用密钥“定义了一个单独的标识符。网络密钥标识符使用7位值在每个 ”Network PDU“ 中传送，而应用密钥标识符使用6位值在每个”Lower Transport PDU“中传送。

#### 2.3.9.4 初始化向量引索 

一个”Network PDU“包含一个24位序列号，允许一个元素发送16,777,216个”Network PDU“。序列号用于安全随机数（security nonce）以提供唯一性，因此序号不能换行。如果元素以2 Hz发送新消息，那么这些序列号将在97天后耗尽。为了使Mesh网络能够运行比序号更长时间段，定义了一个附加的4字节值域，称为IV索引（IV Index），该值包含在安全随机数（security nonce）中。例如，使用相同的2Hz消息频率，Mesh网络的生命周期将能够使用数十亿年。

为了实现从一个 "IV Index" 到下一个 "IV Index" 的逐步过渡，每个”Network PDU“包括用于传输该消息的 "IV Index" 的最低有效位。节点还可以使用IV更新规程，向对等节点发信号通知它正在更新IV索引。此过程至少需要八天时间才能从"IV Index"转换到新"IV Index"，从而将节点发送消息的频率限制在24 Hz内。但是，节点不应在任何10秒的窗口内发送超过100个网络PDU，因此通常需要耗费大约19天的时间。

### 2.3.10 友元关系


低功率节点使用 "友元"来限制他们需要倾听的时间。如果一个节点不能连续接收，那么它可能不会收到它应该处理的Mesh消息。这包括“维护网络安全”和“正常的mesh消息”所需的安全更新。

如果低功耗节点没有收到这样的消息，那么它可能无法按预期运行，并且它也可能无法保持最新的网络安全状态，并且如果在它不知道的情况下更改了此安全性，它最终会退出网络。

友元是“低功耗节点”和“邻居友无节点”之间的特殊关系。这些节点必须位于彼此的单跳内，并处于同一子网内。

友元首先由低功耗节点建立和发起，一旦建立，友元节点将执行一些操作，以帮助降低低功耗节点上的功耗。友元节点为低功耗节点维护一个 “Friend Queue”，该节点存储发往低功耗节点的所有传入消息。当低功耗节点请求时，友元节点将这些消息传递给低功耗节点。另外，友元节点将安全更新传递给低功耗节点。

当在“低功耗节点”和“友元节点”之间建立友元关系时，这两个节点被认为是朋友。

友元节点可以是多个低功耗节点朋友。低功耗节点只能是单个友无节点的朋友。2.3.12章节中的图2.8 显示“友元节点”和“低功耗节点”的Mesh网络的拓扑结构。 

### 2.3.11 特性

 特性节点的功能由它们支持的特性决定，所有节点都有能力收发Mesh消息。节点也可以选择支持一个或多个附加特性：

*  中继特性 - 通过广播继承接收和转发Mesh消息，以启用大型网络的能力。
*  代理特性 - 在“GATT”和“广播继承”之间接收和转发Mesh消息的能力。
*  低功耗特性 - 只有与支持友元特性的节点相结合，才能在网状网络中以显著降低接收方占空比的能力。
*  友元特性 - 通过存储发送给这些节点的消息，来帮助支持低功耗特性的节点进行操作的能力。

节点支持某个特性，特性可以启用或禁用，并且特性启用时，可能正在使用或未使用。

节点支持中继特性，但可能禁用了此功能，但它仍然可以支持中继功能，只是它没有执行该特性所需的功能。中继节点是指支持中继特性 ，并启用中继特性的节点。

节点支持中继特性的，但可能禁用了此功能，但它仍然可支持代理特性，只是它没有执行该特性所需的功能。代理节点是指支持代理特性，并启用代理特性的节点。

节点支持低功耗特性，但不能禁用此特性，并且它必须与支持友元特性的节点，才能建立友元关系 。然后才能使用低功耗特性来减少接收器占空比。支持低功耗特性并且与支持友元特性的节点建立友元关系的节点，称为低功耗节点。

节点支持友元特性，但可能禁用了此特性，但它仍然可以支持友元特性，只是它没有执行该特性所需的功能。支持友元特性的节点启用了友元特性，并且与支持低功耗特性的节点之间具有友元关系的节点，被称为友元节点。

### 2.3.12 拓扑结构

Mesh网络由支持上述各种特性的节点组成。图2.8 显示了Mesh网络的图示。
![]()
*图2.8 mesh 网络拓扑结构图*

如图2.8 所示 三个中继节点：Q，R，S。 三个支持友元功能的节点，分别是N， O，P，但是N没有任何友元关系节点，因此只有O和P是友元节点。五个低功耗节点：I，J，K，L，M，节点I，J和K以P为朋友，而L，M以O为朋友。节点T仅使用 "GATT Bearer" 连接到Mesh网络，因此S必须将所有消息中继给T。

例如，如果消息要从T发送到L，则T将使用 "GATTBearer"将消息发送到节点S，节点S将使用 "ADV Bearer" 重传此消息。节点H，R，N,O在节点S的无线电范围内, 因此他们会收到此消息。节点O作为节点L的友元节点，它将存储该消息，并且如果该消息是分段消息，则节点O将在下层传输层处用确认进行响应。稍后，L将轮询节点O以检查新消息，使得O将T最初发送的消息转发给L。

## 2.4 mesh 网关

mesh网关是一个节点，它能够在mesh网络和非蓝牙技术设备之间转换消息。一个节点可以通过一个mesh网关发送和接收mesh消息，而不处于任何一个中继节点的范围内。

## 2.5 并发极限和限制
## 2.6 拓扑极限和限制
